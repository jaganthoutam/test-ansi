---
  - name: Playbook
    hosts: webserver
    become: yes
    become_user: root
    tasks:
    
      - name: get service facts
        service_facts:

      - name: try to work out how to access the service
        debug:
          var: ansible_facts.services["nginx.service"]

      - name: Check nginx
        shell: systemctl status nginx.service | grep Active | awk -v N=2 '{print $N}'
        register: output

      - name: Stop nginx
        service:
          name: nginx
          state: stopped
        when: output.stdout == 'active'
        
      - name: Check postgresql
        shell: systemctl status postgresql.service | grep Active | awk -v N=2 '{print $N}'
        register: output

      - name: Stop postgresql
        service:
          name: postgresql
          state: stopped
        when: output.stdout == 'active'
        
      - name: Install nginx
        yum:
          name: nginx
          state: present
          
      - name: Ensure bash, OpenSSl, and libssl are the latest versions
        yum: name={{ item }} update_cache=true state=latest
          with_items:
          - bash
          - openssl
          - libssl-dev
          - libssl-doc
        tags: packages
          
      - name: Insert Index Page
        template:
          src: index.html
          dest: /usr/share/nginx/html/index.html

      - name: Start NGiNX
        service:
          name: nginx
          state: started
          
      - name: Start postgresql
        service:
          name: postgresql
          state: started
          
      - name: Enable service nginx, and not touch the state
        service:
          name: nginx
          enabled: yes
               
      - name: Enable service postgresql, and not touch the state
        service:
          name: postgresql
          enabled: yes  
